WITH sub_query AS(
  SELECT
    DATETIME(TIMESTAMP_SECONDS(visitStartTime), 'UTC') AS last_update,
    p.isImpression AS Impression,
    p.isClick AS Click,
    p.productSKU AS sku,
    DW.VERIFY_REGION(geoNetwork.region) AS region,
    REGEXP_EXTRACT(DW.DECODE_URI_COMPONENT(DW.CUSTOM_DIMENSION_BY_INDEX(50,p.customDimensions)), r'\/(http.*)$') AS img_thumbnail
  FROM `table`,
    UNNEST(hits) AS h,
    UNNEST(h.product) AS p
  WHERE
    REGEXP_EXTRACT(p.productSKU , r'([^-]*-[^-]*)') IN {skus}
    AND _TABLE_SUFFIX BETWEEN
        FORMAT_DATE('%Y%m%d', DATE_SUB('{execution_date}', INTERVAL 2 DAY))
        AND FORMAT_DATE('%Y%m%d', DATE_SUB('{execution_date}', INTERVAL 1 DAY))
    AND DATETIME(TIMESTAMP_SECONDS(visitStartTime), 'UTC') BETWEEN
        DATETIME_SUB(DATETIME(TIMESTAMP '{execution_time}', 'UTC'), INTERVAL (48*60) MINUTE) 
        AND DATETIME_SUB(DATETIME(TIMESTAMP '{execution_time}', 'UTC'), INTERVAL (47*60)+50 MINUTE)
    AND h.eventInfo.eventCategory = 'Ecommerce'
    AND h.eventInfo.eventAction = 'Impressions'
    AND DW.CUSTOM_DIMENSION_BY_INDEX(50,p.customDimensions) is not null
)

SELECT
  region,
  REGEXP_EXTRACT(sku , r'([^-]*-[^-]*)') as sku,
  img_thumbnail,
  MAX(last_update) AS last_update,
  SUM(IF(Impression = TRUE, 1,0)) AS impressions,
  SUM(IF (Click = TRUE, 1 ,0)) AS clicks
FROM sub_query
GROUP BY region, sku, img_thumbnail
